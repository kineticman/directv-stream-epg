<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirecTV Stream EPG - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        h1 { font-size: 2em; margin-bottom: 5px; }
        .subtitle { opacity: 0.9; font-size: 0.9em; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border: 1px solid #334155;
        }
        
        .card h2 {
            margin-bottom: 15px;
            color: #a78bfa;
            font-size: 1.3em;
            border-bottom: 2px solid #334155;
            padding-bottom: 10px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-success { background: #10b981; color: white; }
        .status-failed { background: #ef4444; color: white; }
        .status-running { background: #f59e0b; color: white; }
        .status-unknown { background: #6b7280; color: white; }
        
        .file-list {
            list-style: none;
        }
        
        .file-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #0f172a;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }
        
        .file-name {
            font-weight: 600;
            color: #a78bfa;
            margin-bottom: 5px;
        }
        
        .file-name a {
            color: #a78bfa;
            text-decoration: none;
        }
        
        .file-name a:hover {
            color: #c4b5fd;
            text-decoration: underline;
        }
        
        .file-meta {
            font-size: 0.85em;
            color: #94a3b8;
        }
        
        .file-meta span {
            margin-right: 15px;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border: 1px solid #334155;
            border-radius: 4px;
            background: #0f172a;
            color: #94a3b8;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102,126,234,0.4);
        }
        
        .btn:disabled {
            background: #475569;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #334155;
        }
        
        .info-label {
            font-weight: 600;
            color: #94a3b8;
        }
        
        .log-viewer {
            background: #020617;
            color: #cbd5e1;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #1e293b;
        }
        
        .log-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #334155;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            background: #1e293b;
            border: 1px solid #334155;
        }
        
        .alert-info {
            border-left: 4px solid #3b82f6;
        }
        
        .alert strong {
            color: #60a5fa;
        }
        
        code {
            background: #0f172a;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #a78bfa;
            font-size: 0.9em;
        }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .info-row { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì∫ DirecTV Stream EPG</h1>
            <p class="subtitle">Web Admin & File Server</p>
        </header>
        
        <div class="grid">
            <!-- Status Card -->
            <div class="card">
                <h2>System Status</h2>
                <div class="info-row">
                    <span class="info-label">Refresh Status:</span>
                    <span>
                        {% if refresh_running %}
                        <span class="status-badge status-running">Running <span class="spinner"></span></span>
                        {% elif last_refresh_status == 'success' %}
                        <span class="status-badge status-success">Success</span>
                        {% elif last_refresh_status == 'failed' %}
                        <span class="status-badge status-failed">Failed</span>
                        {% else %}
                        <span class="status-badge status-unknown">Unknown</span>
                        {% endif %}
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Refresh:</span>
                    <span>{{ last_refresh_time if last_refresh_time else 'Never' }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Next Scheduled:</span>
                    <span>{{ scheduler_info.schedule }} {{ scheduler_info.timezone }}</span>
                </div>
                <div style="margin-top: 20px;">
                    <button id="refreshBtn" class="btn" onclick="triggerRefresh()" {% if refresh_running %}disabled{% endif %}>
                        üîÑ Refresh Now
                    </button>
                </div>
            </div>
            
            <!-- Files Card -->
            <div class="card">
                <h2>Output Files</h2>
                {% if files %}
                <ul class="file-list">
                    {% for file in files %}
                    <li class="file-item">
                        <div class="file-name">
                            <a href="{{ file.url }}" target="_blank">{{ file.name }}</a>
                        </div>
                        <div class="file-meta">
                            <span>üì¶ {{ file.size_mb }} MB</span>
                            <span>üïê {{ file.modified_ago }}</span>
                        </div>
                        <div style="margin-top: 8px;">
                            <input type="text" 
                                   id="url-{{ loop.index }}" 
                                   value="{{ server_url }}{{ file.url }}" 
                                   readonly 
                                   style="width: 100%; padding: 6px; font-family: monospace; font-size: 0.85em; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                            <button class="btn btn-small" 
                                    onclick="copyUrl('url-{{ loop.index }}')" 
                                    style="margin-top: 5px; width: 100%;">
                                üìã Copy URL
                            </button>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p style="color: #999;">No files generated yet. Run a refresh to create EPG files.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Logs Card -->
        <div class="card">
            <h2>Live Logs</h2>
            <div class="log-controls">
                <button class="btn btn-small" onclick="loadLogs()">üîÑ Refresh Logs</button>
                <button class="btn btn-small" onclick="clearLogs()">üóëÔ∏è Clear Display</button>
            </div>
            <div class="log-viewer" id="logViewer">Loading logs...</div>
        </div>
        
        <div class="alert alert-info">
            <strong>üì° API Endpoints:</strong><br>
            ‚Ä¢ <code>/files/dtv_epg.xml</code> - XMLTV EPG<br>
            ‚Ä¢ <code>/files/dtv_channels.m3u</code> - M3U Playlist<br>
            ‚Ä¢ <code>/files/dtv_channels.json</code> - Channel JSON<br>
            ‚Ä¢ <code>/api/status</code> - JSON Status<br>
            ‚Ä¢ <code>/health</code> - Health Check
        </div>
    </div>
    
    <script>
        // Copy URL to clipboard
        function copyUrl(inputId) {
            const input = document.getElementById(inputId);
            input.select();
            input.setSelectionRange(0, 99999); // For mobile
            
            try {
                document.execCommand('copy');
                
                // Visual feedback
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#10b981';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            } catch (err) {
                alert('Failed to copy. Please select and copy manually.');
            }
        }
        
        // Auto-refresh status every 10 seconds
        setInterval(() => {
            fetch('/api/status')
                .then(r => r.json())
                .then(data => {
                    if (data.refresh_running !== {{ 'true' if refresh_running else 'false' }}) {
                        location.reload();
                    }
                });
        }, 10000);
        
        // Load logs
        function loadLogs() {
            const viewer = document.getElementById('logViewer');
            viewer.textContent = 'Loading logs...';
            
            fetch('/api/logs?lines=100')
                .then(r => {
                    if (!r.ok) {
                        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.logs && data.logs.length > 0) {
                        viewer.textContent = data.logs.join('');
                        viewer.scrollTop = viewer.scrollHeight;
                    } else {
                        viewer.textContent = '[No log entries yet]';
                    }
                })
                .catch(err => {
                    viewer.textContent = `Error loading logs: ${err.message}\n\nTry:\n1. Check that container has write access to /var/log/directv\n2. Run a manual refresh to generate logs\n3. Check browser console for details`;
                    console.error('Log fetch error:', err);
                });
        }
        
        function clearLogs() {
            document.getElementById('logViewer').textContent = '';
        }
        
        function triggerRefresh() {
            if (confirm('Start EPG refresh now? This may take 5-10 minutes.')) {
                const btn = document.getElementById('refreshBtn');
                btn.disabled = true;
                btn.textContent = '‚è≥ Starting...';
                
                fetch('/api/refresh', { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        alert('Refresh started! The page will auto-refresh when complete.');
                        setTimeout(() => location.reload(), 2000);
                    })
                    .catch(err => {
                        alert('Error: ' + err);
                        btn.disabled = false;
                        btn.textContent = 'üîÑ Refresh Now';
                    });
            }
        }
        
        // Load logs on page load
        loadLogs();
        
        // Auto-refresh logs based on refresh status
        function autoRefreshLogs() {
            const isRefreshing = {{ 'true' if refresh_running else 'false' }};
            const interval = isRefreshing ? 5000 : 30000;  // 5s during refresh, 30s otherwise
            
            setTimeout(() => {
                loadLogs();
                autoRefreshLogs();  // Schedule next refresh
            }, interval);
        }
        
        autoRefreshLogs();
    </script>
</body>
</html>
